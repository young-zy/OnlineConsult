<!DOCTYPE html>
<html lang="zh" xmlns:51.703px>
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <title>部门</title>
    <link href="./css/mdui.min.css" rel="stylesheet" type="text/css">
    <script src="./js/mdui.min.js"></script>
</head>

<body class="mdui-appbar-with-toolbar mdui-theme-primary-indigo mdui-theme-accent-pink mdui-loaded">
<script type="text/javascript">

</script>
<script type="text/javascript">
    function getQueryVariable(variable) {
        let query = window.location.search.substring(1);
        let vars = query.split("&");
        for (let i = 0; i < vars.length; i++) {
            let pair = vars[i].split("=");
            if (pair[0] === variable) {
                return pair[1];
            }
        }
        return false;
    }

    let $$ = mdui.JQ;
    $$.ajaxSetup({
        beforeSend: function (xhr) {
            xhr.setRequestHeader('token', window.localStorage.getItem('token'));
        }
    });

    let currentPage = getQueryVariable('page');
    if (currentPage === false) {
        currentPage = 1;
    }

    let totPage = 1;

    $$.ajax({
        method: 'GET',
        url: './department/count',
        success: function (data, textStatus, xhr) {
            totPage = Math.ceil(parseInt(xhr.responseText) / 10.0);
        },
        error: function (xhr, textStatus) {
            if (xhr.status === 403) {
                if (window.localStorage.getItem('token')) {
                    $$('#dialog_title').text("登陆已过期");
                } else {
                    $$('#dialog_title').text("您还未登陆");
                }
                let dialog = new mdui.Dialog('#redirectToLoginDialog');
                let temp = document.getElementById('redirectToLoginDialog');
                temp.addEventListener('closed.mdui.dialog', function () {
                    window.location.assign('./login.html?back=' + window.location.href.replace('#mdui-dialog', ''));
                    console.log('redirect to login');
                    return false
                });
                temp.addEventListener('confirm.mdui.dialog', function () {
                    window.location.assign('./login.html?back=' + window.location.href.replace('#mdui-dialog', ''));
                    console.log('redirect to login');
                    return false
                });
                dialog.open();
            } else {
                let msg = JSON.parse(xhr.responseText);
                mdui.snackbar(
                    {
                        message: msg["reason"],
                        position: 'top',
                        timeout: 4000
                    }
                );
                console.log(msg);
            }
        }
    });

    if (currentPage > totPage) {
        currentPage = totPage;
        window.location.href = "./index.html?page=" + totPage;
    } else if (currentPage < 1) {
        currentPage = 1;
        window.location.href = "./index.html";
    }

    $$.ajax({
        method: 'GET',
        url: './department?page=' + currentPage,
        success: function (data, textStatus, xhr) {
            let li = JSON.parse(xhr.responseText);
            let list = document.getElementById('list');
            li.forEach(function (it) {
                let listItem = document.createElement('li');
                let div = document.createElement('div');
                div.setAttribute("class", "mdui-list-item mdui-ripple mdui-card");
                div.setAttribute("style", "padding: 10px;font-weight: 400;");
                let url = document.createElement('a');
                url.setAttribute('href', './department.html?department=' + it['departmentId']);
                url.setAttribute('style', 'width: 100%;');
                url.innerText = it['departmentName'];
                div.appendChild(url);
                listItem.appendChild(div);
                list.appendChild(listItem);
            });
            let pageInfo = document.getElementById("page-info");
            pageInfo.innerText = '当前 第' + currentPage + '页， 共 ' + totPage + '页';
            if (currentPage === 1) {
                document.getElementById('previous-button').setAttribute('disabled', '');
            }
            if (currentPage === totPage) {
                document.getElementById('next-button').setAttribute('disabled', '');
            }
        },
        error: function (xhr, textStatus) {
            if (xhr.status === 403) {
                if (window.localStorage.getItem('token')) {
                    $$('#dialog_title').text("登陆已过期");
                } else {
                    $$('#dialog_title').text("您还未登陆");
                }
                let dialog = new mdui.Dialog('#redirectToLoginDialog');
                let temp = document.getElementById('redirectToLoginDialog');
                temp.addEventListener('closed.mdui.dialog', function () {
                    window.location.assign('./login.html?back=' + window.location.href.replace('#mdui-dialog', ''));
                    console.log('redirect to login');
                    return false
                });
                temp.addEventListener('confirm.mdui.dialog', function () {
                    window.location.assign('./login.html?back=' + window.location.href.replace('#mdui-dialog', ''));
                    console.log('redirect to login');
                    return false
                });
                dialog.open();
            } else {
                let msg = JSON.parse(xhr.responseText);
                mdui.snackbar(
                    {
                        message: msg["reason"],
                        position: 'top',
                        timeout: 4000
                    }
                );
                console.log(msg);
            }
        }
    });

    $$.ajax({
        method: 'GET',
        url: './message/count',
        success: function (data, textStatus, xhr) {
            let count = parseInt(xhr.responseText);
            document.getElementById('new-message').innerText = '新消息：' + count + '条';
        },
        error: function (xhr, textStatus) {
            if (xhr.status === 403) {

            } else {
                let msg = JSON.parse(xhr.responseText);
                mdui.snackbar(
                    {
                        message: msg["reason"],
                        position: 'top',
                        timeout: 4000
                    }
                );
                console.log(msg);
            }
        }
    });

    function logout() {
        $$.ajax({
            method: 'POST',
            url: './user/logout',
            success: function (data, textStatus, xhr) {

            },
            error: function (xhr, textStatus) {
                if (xhr.status === 403) {

                } else {
                    let msg = JSON.parse(xhr.responseText);
                    mdui.snackbar(
                        {
                            message: msg["reason"],
                            position: 'top',
                            timeout: 4000
                        }
                    );
                    console.log(msg);
                }
            }
        });
        window.localStorage.clear();
        location.reload();
    }

    function nextPage() {
        window.location.href = './index.html?page=' + (currentPage + 1);
    }

    function previousPage() {
        window.location.href = './index.html?page=' + (currentPage - 1);
    }


</script>
<header class="mdui-appbar mdui-appbar-fixed">
    <div class="mdui-toolbar mdui-color-theme">
        <a class="mdui-typo-headline mdui-hidden-xs" href="./index.html">在线问答系统</a>
        <a class="mdui-typo-title" href="">部门</a>
        <div class="mdui-toolbar-spacer"></div>
        <button class="mdui-btn" href="./messages.html" id="new-message"></button>
        <button class="mdui-btn" onclick="logout()">登出</button>
    </div>
</header>
<br><br><br>
<div class="mdui-container">

    <div class="mdui-list" id="list" style="font-size: 20px">

    </div>

    <div class="mdui-dialog" id="redirectToLoginDialog">
        <div class="mdui-dialog-title" id="dialog_title">您还未登陆</div>
        <div class="mdui-dialog-content">点击确认跳转至登陆页面!</div>
        <div class="mdui-dialog-actions">
            <button class="mdui-btn mdui-ripple" mdui-dialog-confirm>OK</button>
        </div>
    </div>
    <div class="mdui-center mdui-text-center" id="page-info" style="font-size: 15px"></div>
    <div>
        <button class="mdui-btn" id="previous-button" onclick="previousPage()"><i class="mdui-icon material-icons">&#xe5cb;</i>上一页
        </button>
        <button class="mdui-btn" id="next-button" onclick="nextPage()" style="float: right">下一页<i
                class="mdui-icon material-icons">&#xe5cc;</i>
        </button>
    </div>
</div>
</body>
</html>